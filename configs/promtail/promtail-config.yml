server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    # Batching for efficiency
    batchwait: 1s
    batchsize: 1048576  # 1MB

    # Retry configuration
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

scrape_configs:
  # Scrape all Docker container logs
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # Only scrape ctc-db-api container
      - source_labels: ['__meta_docker_container_name']
        regex: '/(ctc-db-api|ctc-api|ctc-db-api).*'
        action: keep

      # Set job label from container name
      - source_labels: ['__meta_docker_container_name']
        target_label: 'job'
        replacement: 'ctc-db-api'

      # Extract container name without leading slash
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
        regex: '/(.*)'
        replacement: '${1}'

      # Add container ID
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'
        regex: '(.{12}).*'
        replacement: '${1}'

    pipeline_stages:
      # Stage 1: Parse JSON logs
      - json:
          expressions:
            level: level
            timestamp: ts
            message: msg
            caller: caller
            trace_id: trace.id
            span_id: span.id
            request_id: http.request_id
            user_id: user.id
            http_method: http.method
            http_route: http.route
            http_status: http.status_code
            http_duration: http.request.duration
            http_request_body_size: http.request.body.size
            http_response_body_size: http.response.body.size
            service_name: service.name
            environment: environment
            db_system: db.system

      # Stage 2: Extract labels (indexed fields)
      - labels:
          level:
          trace_id:
          http_status:
          http_method:
          service_name:
          environment:

      # Stage 3: Set timestamp from log
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Stage 4: Drop healthcheck/readiness logs (optional)
      - match:
          selector: '{http_route="/health"}'
          action: drop

      # Stage 5: Add static labels
      - static_labels:
          service: ctc-db-api
